/**
 * Utility functions for vulnerability display and formatting
 */

import { SafeVersion } from "../types";

export function getMaxSeverity(vulnerabilities: any[]): string {
  const severityOrder = ["critical", "high", "moderate", "low", "info"];
  for (const severity of severityOrder) {
    if (vulnerabilities.some((v) => v.severity === severity)) return severity;
  }
  return "info";
}

export function getVulnerabilityIcon(severity: string): string {
  switch (severity) {
    case "critical":
      return "â›”";
    case "high":
      return "ðŸ”´";
    case "moderate":
      return "ðŸŸ ";
    case "low":
      return "ðŸŸ¡";
    default:
      return "â„¹ï¸";
  }
}

export function getVulnerabilitySummary(
  vulnerabilities: any[] | undefined
): string | undefined {
  if (!vulnerabilities || vulnerabilities.length === 0) return;

  const criticalCount = vulnerabilities.filter(
    (v) => v.severity === "critical"
  ).length;
  const highCount = vulnerabilities.filter((v) => v.severity === "high").length;
  const moderateCount = vulnerabilities.filter(
    (v) => v.severity === "moderate"
  ).length;
  const lowCount = vulnerabilities.filter((v) => v.severity === "low").length;

  const parts: string[] = [];
  if (criticalCount > 0)
    parts.push(`${getVulnerabilityIcon("critical")} ${criticalCount} critical`);
  if (highCount > 0)
    parts.push(`${getVulnerabilityIcon("high")} ${highCount} high`);
  if (moderateCount > 0)
    parts.push(`${getVulnerabilityIcon("moderate")} ${moderateCount} moderate`);
  if (lowCount > 0)
    parts.push(`${getVulnerabilityIcon("low")} ${lowCount} low`);

  return parts.join(", ");
}

export function getSafetyStatus(
  version: SafeVersion,
  maxSeverity: string
): string {
  const vulnerabilities = version.vulnerabilities || [];
  const inQuarantine = !version.isSafe;

  // Check if it has vulnerabilities above the max severity threshold
  const hasVulnerabilities = vulnerabilities.length > 0;
  let hasHigherSeverity = false;

  if (hasVulnerabilities) {
    const severityOrder = ["critical", "high", "moderate", "low", "info"];
    const maxIndex = severityOrder.indexOf(maxSeverity);

    hasHigherSeverity = vulnerabilities.some((v: any) => {
      const vulnIndex = severityOrder.indexOf(v.severity);
      return vulnIndex <= maxIndex;
    });
  }

  if (!inQuarantine && !hasHigherSeverity) return "$(check) Ok";

  const statuses: string[] = [];

  if (inQuarantine) statuses.push("$(lock) In quarantine");
  if (hasHigherSeverity) statuses.push("$(alert) Has vulnerabilities");
  return statuses.join(" + ");
}
