/**
 * Utility functions for vulnerability display and formatting
 */

export function getMaxSeverity(vulnerabilities: any[]): string {
  const severityOrder = ["critical", "high", "moderate", "low", "info"];
  for (const severity of severityOrder) {
    if (vulnerabilities.some((v) => v.severity === severity)) return severity;
  }
  return "info";
}

export function getVulnerabilityIcon(severity: string): string {
  switch (severity) {
    case "critical":
      return "â›”";
    case "high":
      return "ðŸ”´";
    case "moderate":
      return "ðŸŸ ";
    case "low":
      return "ðŸŸ¡";
    default:
      return "â„¹ï¸";
  }
}

export function getVulnerabilitySummary(
  vulnerabilities: any[] | undefined
): string {
  if (!vulnerabilities || vulnerabilities.length === 0) {
    return "";
  }

  const criticalCount = vulnerabilities.filter(
    (v) => v.severity === "critical"
  ).length;
  const highCount = vulnerabilities.filter((v) => v.severity === "high").length;
  const moderateCount = vulnerabilities.filter(
    (v) => v.severity === "moderate"
  ).length;
  const lowCount = vulnerabilities.filter((v) => v.severity === "low").length;

  const parts: string[] = [];
  if (criticalCount > 0) parts.push(`${criticalCount} critical`);
  if (highCount > 0) parts.push(`${highCount} high`);
  if (moderateCount > 0) parts.push(`${moderateCount} moderate`);
  if (lowCount > 0) parts.push(`${lowCount} low`);

  return parts.join(", ");
}

export function getSafetyStatus(
  version: any,
  maxSeverity: string
): { icon: string; text: string } {
  const vulnerabilities = version.vulnerabilities || [];

  if (vulnerabilities.length === 0) {
    if (version.reason === "in quarantine") {
      return { icon: "ðŸ”’", text: "In quarantine" };
    }
    return { icon: "âœ…", text: "Safe" };
  }

  // Check if it has vulnerabilities above the max severity threshold
  const severityOrder = ["critical", "high", "moderate", "low", "info"];
  const maxIndex = severityOrder.indexOf(maxSeverity);

  const hasHigherSeverity = vulnerabilities.some((v: any) => {
    const vulnIndex = severityOrder.indexOf(v.severity);
    return vulnIndex <= maxIndex;
  });

  const maxVulnSeverity = getMaxSeverity(vulnerabilities);
  const icon = getVulnerabilityIcon(maxVulnSeverity);

  if (hasHigherSeverity) return { icon, text: `Has vulnerabilities` };

  return { icon, text: `Minor vulnerabilities only` };
}
